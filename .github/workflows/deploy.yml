name: ğŸš€ Deploy Workshop App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout Code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup SSH
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # 3ï¸âƒ£ Deploy to EC2
      - name: ğŸš€ Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            APP_DIR="/home/${{ secrets.EC2_USER }}/workshop-registration-github-Actions"
            cd "$APP_DIR"

            echo "ğŸ“¦ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main

            echo "ğŸ§¾ Writing clean .env file..."
            cat > .env <<EOL
            NODE_ENV=production
            PORT=5000

            # Database
            DB_HOST=${{ secrets.DB_HOST }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_NAME=${{ secrets.DB_NAME }}

            # Email
            SMTP_HOST=${{ secrets.SMTP_HOST }}
            SMTP_PORT=${{ secrets.SMTP_PORT }}
            SMTP_USER=${{ secrets.SMTP_USER }}
            SMTP_PASS=${{ secrets.SMTP_PASS }}
            FROM_EMAIL=${{ secrets.FROM_EMAIL }}
            FROM_NAME=${{ secrets.FROM_NAME }}
            EOL

            echo "ğŸ—ï¸ Building frontend..."
            npm ci
            npm run build

            echo "ğŸ³ Building backend Docker image..."
            sudo docker stop workshop-backend || true
            sudo docker rm workshop-backend || true
            sudo docker rmi workshop-backend:latest || true
            sudo docker build -t workshop-backend:latest .

            echo "ğŸš€ Running backend container..."
            sudo docker run -d \
              --name workshop-backend \
              -p 5000:5000 \
              --env-file .env \
              --restart unless-stopped \
              workshop-backend:latest

            echo "ğŸŒ Installing and configuring NGINX..."
            sudo apt-get update -qq && sudo apt-get install -y nginx

            sudo tee /etc/nginx/sites-available/workshop.conf > /dev/null << 'NGINX_CONF'
            server {
              listen 80;
              server_name _;

              # Frontend (Nuxt/Vue build)
              location / {
                root /home/${{ secrets.EC2_USER }}/workshop-registration-github-Actions/.output/public;
                index index.html;
                try_files $uri $uri/ /index.html;
              }

              # Backend API
              location /api/ {
                proxy_pass http://localhost:5000;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_cache_bypass $http_upgrade;
              }

              # Health check
              location /health {
                proxy_pass http://localhost:5000/health;
              }
            }
            NGINX_CONF

            sudo ln -sf /etc/nginx/sites-available/workshop.conf /etc/nginx/sites-enabled/
            sudo rm -f /etc/nginx/sites-enabled/default
            sudo nginx -t && sudo systemctl restart nginx

            echo "âœ… Deployment complete!"
            echo "ğŸŒ Frontend â†’ http://${{ secrets.EC2_HOST }}"
            echo "ğŸ”§ Backend â†’ http://${{ secrets.EC2_HOST }}/api"
            echo "ğŸ¥ Health â†’ http://${{ secrets.EC2_HOST }}/health"

            echo "ğŸ“Š Active Docker containers:"
            sudo docker ps
          EOF
