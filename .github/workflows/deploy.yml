name: Deploy Workshop App to EC2

on:
  push:
    branches:
      - main  # Deploy only on main branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------
      # 1Ô∏è‚É£ Checkout Code
      # ---------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------
      # 2Ô∏è‚É£ Setup SSH for EC2 Access
      # ---------------------------------------
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # ---------------------------------------
      # 3Ô∏è‚É£ Deploy to EC2
      # ---------------------------------------
      - name: üöÄ Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e

            APP_DIR="/home/${{ secrets.EC2_USER }}/workshop-registration-github-Actions"
            cd "$APP_DIR"

            echo "üì¶ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main

            echo "üßæ Checking for .env file..."
            if [ ! -f .env ]; then
              echo "‚ùå Missing .env file in EC2 directory!"
              exit 1
            fi

            echo "üèóÔ∏è Building frontend..."
            npm ci
            npm run build

            echo "üê≥ Building backend Docker image..."
            sudo docker stop workshop-backend || true
            sudo docker rm workshop-backend || true
            sudo docker rmi workshop-backend:latest || true
            sudo docker build -t workshop-backend:latest .

            echo "üöÄ Running backend container..."
            sudo docker run -d \
              --name workshop-backend \
              -p 5000:5000 \
              --env-file .env \
              --restart unless-stopped \
              workshop-backend:latest

            echo "üåê Installing and configuring NGINX..."
            sudo apt-get update -qq && sudo apt-get install -y nginx

            # --- Configure NGINX ---
            sudo tee /etc/nginx/sites-available/workshop.conf > /dev/null << 'NGINX_CONF'
            server {
              listen 80;
              server_name _;

              # Serve frontend build output (Nuxt/Vue)
              location / {
                root /home/${{ secrets.EC2_USER }}/workshop-registration-github-Actions/.output/public;
                index index.html;
                try_files $uri $uri/ /index.html;
              }

              # Proxy backend requests
              location /api/ {
                proxy_pass http://localhost:5000;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_cache_bypass $http_upgrade;
              }

              # Healthcheck
              location /health {
                proxy_pass http://localhost:5000/health;
              }
            }
            NGINX_CONF

            sudo ln -sf /etc/nginx/sites-available/workshop.conf /etc/nginx/sites-enabled/
            sudo rm -f /etc/nginx/sites-enabled/default
            sudo nginx -t && sudo systemctl restart nginx

            echo "‚úÖ Deployment complete!"
            echo "üåç Frontend ‚Üí http://${{ secrets.EC2_HOST }}"
            echo "üîß Backend ‚Üí http://${{ secrets.EC2_HOST }}/api"
            echo "üè• Health ‚Üí http://${{ secrets.EC2_HOST }}/health"

            echo "üìä Current Docker containers:"
            sudo docker ps
          EOF
