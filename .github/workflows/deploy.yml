name: Fullstack App Deployment to EC2

on:
  push:
    branches:
      - main # Runs only when you push to main branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # --- Checkout code from GitHub ---
      - name: Checkout code
        uses: actions/checkout@v4

      # --- Setup Node.js ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # --- Verify required secrets ---
      - name: Verify required secrets
        run: |
          echo "ðŸ” Checking required secrets..."
          if [ -z "${{ secrets.EC2_HOST }}" ]; then
            echo "âŒ Missing secret: EC2_HOST"
            exit 1
          fi
          if [ -z "${{ secrets.EC2_USER }}" ]; then
            echo "âŒ Missing secret: EC2_USER"
            exit 1
          fi
          if [ -z "${{ secrets.EC2_SSH_KEY }}" ]; then
            echo "âŒ Missing secret: EC2_SSH_KEY"
            exit 1
          fi
          echo "âœ… All required secrets found"

      # --- Configure SSH Key Manually ---
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "âœ… SSH key configured successfully"

      # --- (Optional) SSH Agent setup for compatibility ---
      - name: Add SSH key to agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      # --- Deploy to EC2 ---
      - name: Deploy to EC2 Server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e

            echo "ðŸš€ Starting deployment..."

            # Go to existing app directory
            APP_DIR="/home/${{ secrets.EC2_USER }}/workshop-registration-github-Actions"

            cd "$APP_DIR"

            echo "ðŸ“¥ Pulling latest changes..."
            git reset --hard
            git pull origin main

            echo "ðŸ“¦ Installing dependencies..."
            npm ci

            echo "ðŸ—ï¸ Building frontend..."
            npm run build

            echo "ðŸ§© Updating .env file..."
            cat > .env <<EOL
            DB_HOST=${{ secrets.DB_HOST }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_NAME=${{ secrets.DB_NAME }}

            SMTP_HOST=${{ secrets.SMTP_HOST }}
            SMTP_PORT=${{ secrets.SMTP_PORT }}
            SMTP_USER=${{ secrets.SMTP_USER }}
            SMTP_PASS=${{ secrets.SMTP_PASS }}
            FROM_EMAIL=${{ secrets.FROM_EMAIL }}
            FROM_NAME=${{ secrets.FROM_NAME }}

            PORT=${{ secrets.PORT }}
            API_BASE_URL=${{ secrets.API_BASE_URL }}
            EOL

            echo "ðŸ³ Cleaning up old Docker containers..."
            docker stop workshop-app || true
            docker rm workshop-app || true
            docker rmi workshop-app:latest || true

            echo "ðŸ”¨ Building new Docker image..."
            docker build -t workshop-app:latest .

            echo "ðŸš€ Starting updated container..."
            docker run -d \
              --name workshop-app \
              -p 3000:3000 \
              -p 5000:5000 \
              --env-file .env \
              --restart unless-stopped \
              workshop-app:latest

            echo "âœ… Deployment completed successfully!"
            echo "ðŸŒ Frontend â†’ http://${{ secrets.EC2_HOST }}:3000"
            echo "ðŸ”§ Backend  â†’ http://${{ secrets.EC2_HOST }}:5000"

            echo "ðŸ“Š Active containers:"
            docker ps | grep workshop-app || echo "âš ï¸ Container not running!"
          EOF
